
const express = require("express");
const fetch = require("node-fetch");
require("dotenv").config();
const nano = require("nano");
const app = express();
const couch_database = nano(process.env.COUCHDB_URL);

app.use(express.json());
const the_database = couch_database.db.use('final_year_project');
app.use(express.static("public"));

    // retrieve the latest recommendation from the database
    app.get("/retrieve-recommendations", async(request,response)=>
    {
        try{
            // find all documents in the database where
            const query = await the_database.find({
                selector:
                {
                    user_prompt: {"$exists": true } // the user prompt exists
                },
                fields:
                [
                    "the_output" // only the output field is retrieved
                ],
                sort:
                 [
                    { date_inserted: "desc" } // sorted by id in descending order
                 ],
                    limit: 1 // enforce a limit of 1 to show only the latest recommendation
                
            });
            // if there are no documents or the document length is 0
            if(!query.docs || query.docs.length === 0)
            {
                console.log("no documents found");
                return response.json({ output: "recommendations not available" });
            }
            // set the response as the first result document generated by running the query
            const retrieved_response = query.docs[0];
            // send the response to the frontend
           response.json({ output: retrieved_response.the_output });
           

        }catch(err){
            console.log("failed to retrieve recommendations from the database",err);
            return;
        };
    });

    app.post("/submit-prompt",  async (request,response)=>{
        // extract the prompt from the body and remove trailing whitespace characters
        const user_prompt = request.body.user_prompt.trim(); 
            try {
        
                // post the user prompt to the OpenRouter API
        const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
            method: "POST",
            headers: {
            "Authorization": "Bearer " + process.env.OPENROUTER_API_KEY,
            "Content-Type": "application/json",
            "HTTP-Referer": "http://localhost:3000", 
            "X-Title": "SaaS Idea Generator"
            
            },
            body: JSON.stringify(
                // indicates the AI model used
                {  model: "openrouter/auto", messages: [
    { role: "system", content: "none" },
    { role: "user", content: user_prompt } // sends the user prompt

  ], max_tokens: 50 }) // sets a maximum token limit 

        });

    if (!resp.ok) 
    {
        const error_text = await resp.text();
        console.error("Model API error:", error_text);
        return response.status(resp.status).json({ error: error_text });
    }

        // asynchronously wait for the JSON response
        const result = await resp.json();
        // parse the response and extract the text content
        const content = result.choices[0].message.content
        const formatted = JSON.stringify(result);
        // insert the formatted response and the user prompt into the database
        await the_database.insert({ user_prompt,the_output: formatted, date_inserted: new Date().toISOString() });
        console.log("Inserted document:", { user_prompt, the_output: formatted, date_inserted: new Date().toISOString() });
        console.log("Model output:", formatted);
        // if no content is included in the response
        if(!content)
        {
            console.log("content is empty");
        }
        else
        {
            // return the content to the front-end in JSON form
            response.json({output: content});
        }
        } catch (err) {
            console.error("Error inserting prompt to database",err);
        }
    
    });

    app.listen(3000, ()=>
    {
        console.log("listening on port 3000")
    }
    );

    app.post("/register_details", async (request,response)=>
    {
        const username = request.body.username;
        const password = request.body.password;
        const email = request.body.email;
        try
        {
            await the_database.insert({username:username,password:password,email:email});
            console.log("Inserted user's personal details into the database");
            response.json({success: true, message: "data saved successfully"})
        }
        catch(err)
        {
            console.error("error inserting the data into the database",err);
            response.status(400).end("data unsuccessfully inserted into database");
        }
    })

    app.post("/idea_details", async (request,response)=>
    {
        const ideas = request.body.ideas;
        const username = request.body.username;
        try
        {
            await the_database.insert({username:username,ideas:ideas});
            console.log("Inserted user's idea list into the database");
            response.json({success: true, message: "data saved successfully"})
        }
        catch(err)
        {
            console.error("error inserting the data into the database",err);
            response.status(400).end("data unsuccessfully inserted into database");
        }
    })

    app.post("/product_details", async (request,response)=>
    {
        const products = request.body.products
        const username = request.body.username;
        try
        {
            await the_database.insert({username:username,products:products});
            console.log("Inserted user's product portfolio into the database");
            response.json({success: true, message: "data saved successfully"})
        }
        catch(err)
        {
            console.error("error inserting the data into the database",err);
            response.status(400).end("data unsuccessfully inserted into database");
        }
    })




